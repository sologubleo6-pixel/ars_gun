<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Debug Shop</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding-bottom: 200px; background: #f0f0f0; }
        
        /* Стили для кнопки админа */
        #admin-btn {
            position: fixed; top: 20px; right: 20px; z-index: 999;
            width: 60px; height: 60px; border-radius: 50%;
            background: red; color: white; font-size: 30px; border: none;
            /* УБРАЛИ display:none, чтобы кнопка была видна всегда для теста */
            display: block; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        /* ОКНО ОТЛАДКИ (ЧЕРНОЕ) */
        #debug-console {
            position: fixed; bottom: 0; left: 0; right: 0; height: 150px;
            background: black; color: lime; font-family: monospace;
            font-size: 12px; padding: 10px; overflow-y: scroll; z-index: 10000;
            border-top: 2px solid lime; opacity: 0.9;
        }

        .item-card { background: white; padding: 10px; margin: 10px; border-radius: 10px; }
        img { max-width: 100%; height: auto; }
        
        /* Форма */
        #post-form {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 160px; /* выше консоли */
            background: white; z-index: 2000; padding: 20px; overflow-y: auto;
        }
        input, textarea, select { width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; }
    </style>
</head>
<body>

    <button id="admin-btn" onclick="openForm()">+</button>

    <div id="debug-console">Инициализация консоли...<br></div>

    <div id="content" style="padding: 10px;">
        <h2>Товары:</h2>
        <div id="list">Загрузка...</div>
    </div>

    <div id="post-form">
        <h3>Добавить товар</h3>
        <input id="f-cat" placeholder="Категория (новости/порох...)">
        <input id="f-name" placeholder="Название">
        <input id="f-price" placeholder="Цена">
        <input id="f-photo" placeholder="Ссылка на фото">
        <textarea id="f-desc" placeholder="Описание"></textarea>
        <button onclick="sendData()" style="padding:15px; width:100%; background:blue; color:white;">ОТПРАВИТЬ</button>
        <button onclick="closeForm()" style="margin-top:10px;">ЗАКРЫТЬ</button>
    </div>

    <script>
        // === НАСТРОЙКИ ===
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxJ1MQVgpKYmiujowLKGAh1ZCO8vR5qryOHPfcwjylzMBFY7OmvVIu3CbCA2kVfOGBXjw/exec';
        const MY_ID = 0; // Пока неважно, мы тестируем
        // ================

        const consoleDiv = document.getElementById('debug-console');
        function log(msg) {
            consoleDiv.innerHTML += `> ${msg}<br>`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // 1. ПРОВЕРКА ID
        try {
            log("Старт скрипта");
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                log("Твой ID: " + tg.initDataUnsafe.user.id);
                log("Имя: " + tg.initDataUnsafe.user.first_name);
            } else {
                log("⚠️ Пользователь не найден! (Ты в браузере?)");
            }
        } catch (e) {
            log("Ошибка Telegram: " + e.message);
        }

        // 2. ЗАГРУЗКА ДАННЫХ
        async function load() {
            log("Пробую скачать данные...");
            try {
                // Добавляем ?action=read для проверки
                const res = await fetch(WEB_APP_URL + "?action=read&t=" + Date.now());
                log("Ответ сервера статус: " + res.status);
                
                if (!res.ok) throw new Error("Сервер ответил ошибкой");
                
                const text = await res.text();
                log("Получено байт: " + text.length);
                
                // Пробуем парсить JSON
                try {
                    const data = JSON.parse(text);
                    log("JSON успешен. Элементов: " + data.length);
                    
                    document.getElementById('list').innerHTML = '';
                    data.forEach(row => {
                        document.getElementById('list').innerHTML += `
                            <div class="item-card">
                                <b>${row[1]}</b> (${row[2]})<br>
                                ${row[4]}
                            </div>
                        `;
                    });
                } catch (jsonErr) {
                    log("❌ ЭТО НЕ JSON! Вот начало ответа:");
                    log(text.substring(0, 100)); // Покажем первые 100 символов
                }

            } catch (e) {
                log("❌ ОШИБКА ЗАГРУЗКИ: " + e.message);
            }
        }

        // 3. ОТПРАВКА ДАННЫХ
        function openForm() { document.getElementById('post-form').style.display = 'block'; }
        function closeForm() { document.getElementById('post-form').style.display = 'none'; }

        async function sendData() {
            log("Отправка данных...");
            const data = {
                action: 'add',
                category: document.getElementById('f-cat').value,
                name: document.getElementById('f-name').value,
                price: document.getElementById('f-price').value,
                photo: document.getElementById('f-photo').value,
                desc: document.getElementById('f-desc').value
            };

            try {
                // Используем no-cors, так как Apps Script часто блокирует CORS
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    body: JSON.stringify(data)
                });
                log("✅ Запрос отправлен (no-cors)!");
                log("Перезагрузка через 2 сек...");
                setTimeout(() => location.reload(), 2000);
            } catch (e) {
                log("❌ Ошибка отправки: " + e.message);
            }
        }

        load();
    </script>
</body>
</html>
