<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { 
            --tg-bg: var(--tg-theme-bg-color, #f0f2f5); 
            --tg-text: var(--tg-theme-text-color, #000); 
            --tg-link: var(--tg-theme-link-color, #248bed); 
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #ffffff); 
            --tg-hint: var(--tg-theme-hint-color, #888);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--tg-bg); color: var(--tg-text); margin: 0; padding-bottom: 90px; }
        
        .page { display: none; padding: 15px; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* –ì–ê–õ–ï–†–ï–Ø –ö–ê–†–¢–û–ß–ö–ò */
        .item-card { background: var(--tg-secondary-bg); border-radius: 16px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08); position: relative; }
        .gallery-wrapper { position: relative; width: 100%; background: #eee; }
        .gallery { display: flex; overflow-x: auto; snap-type: x mandatory; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
        .gallery::-webkit-scrollbar { display: none; }
        .gallery img { width: 100%; flex-shrink: 0; snap-align: start; max-height: 380px; object-fit: cover; }
        
        /* –ò–ù–î–ò–ö–ê–¢–û–†–´ –¢–û–ß–ö–ò */
        .dots { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; pointer-events: none; }
        .dot { width: 6px; height: 6px; border-radius: 50%; background: rgba(255,255,255,0.5); }
        .dot.active { background: white; width: 8px; height: 8px; }

        .item-info { padding: 16px; }
        .item-price { background: var(--tg-link); color: white; padding: 4px 10px; border-radius: 8px; font-weight: bold; font-size: 15px; display: inline-block; margin-bottom: 8px; }
        .item-title { font-size: 18px; font-weight: 800; display: block; margin-bottom: 6px; }
        .item-desc { font-size: 14px; color: var(--tg-text); opacity: 0.9; line-height: 1.5; white-space: pre-wrap; }

        /* –ö–ù–û–ü–ö–ò –ê–î–ú–ò–ù–ê */
        .admin-controls { display: flex; gap: 8px; margin-top: 15px; }
        .btn-edit { background: #e3f2fd; color: #1976d2; border: none; padding: 10px; border-radius: 10px; flex: 1; font-weight: bold; }
        .btn-delete { background: #ffebee; color: #d32f2f; border: none; padding: 10px; border-radius: 10px; flex: 1; font-weight: bold; }

        #admin-btn { position: fixed; bottom: 90px; right: 20px; z-index: 999; display: none; background: #ff4444; color: white; border: none; border-radius: 50%; width: 60px; height: 60px; font-size: 35px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }

        /* –ù–ê–í–ò–ì–ê–¶–ò–Ø */
        .tab-bar { position: fixed; bottom: 0; left: 0; right: 0; height: 75px; background: var(--tg-secondary-bg); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid rgba(0,0,0,0.05); z-index: 1000; }
        .tab-item { text-align: center; font-size: 10px; color: var(--tg-hint); flex: 1; padding: 10px 0; }
        .tab-item.active { color: var(--tg-link); }
        .tab-item .icon { font-size: 24px; display: block; margin-bottom: 4px; }

        /* –§–û–†–ú–ê */
        .form-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--tg-bg); z-index: 2000; padding: 20px; overflow-y: auto; }
        input, textarea, select { width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid rgba(0,0,0,0.1); border-radius: 12px; font-size: 16px; box-sizing: border-box; background: var(--tg-secondary-bg); color: var(--tg-text); }
        
        .support-btn { background: #28a745; color: white; border: none; padding: 12px; border-radius: 12px; width: 100%; margin: 20px 0; font-weight: bold; font-size: 16px; }
    </style>
</head>
<body>

<button id="admin-btn" onclick="openAddForm()">+</button>

<div id="feed" class="page active"><h2>üî• –ù–æ–≤–∏–Ω–∫–∏</h2><div id="feed-list"></div><button class="support-btn" onclick="askQuestion()">üí¨ –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∞–¥–º–∏–Ω—É</button></div>
<div id="powder" class="page"><h2>üß™ –ü–æ—Ä–æ—Ö</h2><div id="powder-list"></div></div>
<div id="ammo" class="page"><h2>üî´ –ü–∞—Ç—Ä–æ–Ω—ã</h2><div id="ammo-list"></div></div>
<div id="guns" class="page"><h2>üß∞ –û—Ä—É–∂–∏–µ</h2><div id="guns-list"></div></div>
<div id="commission" class="page"><h2>‚ôªÔ∏è –ö–æ–º–∏—Å—Å–∏–æ–Ω–∫–∞</h2><div id="comm-list"></div></div>

<div id="post-form" class="form-overlay">
    <h3 id="form-title">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h3>
    <select id="f-cat">
        <option value="–ù–æ–≤–æ—Å—Ç–∏">–õ–µ–Ω—Ç–∞</option>
        <option value="–ü–æ—Ä–æ—Ö">–ü–æ—Ä–æ—Ö</option>
        <option value="–ü–∞—Ç—Ä–æ–Ω—ã">–ü–∞—Ç—Ä–æ–Ω—ã</option>
        <option value="–û—Ä—É–∂–∏–µ">–û—Ä—É–∂–∏–µ</option>
        <option value="–ö–æ–º–∏—Å—Å–∏–æ–Ω–∫–∞">–ö–æ–º–∏—Å—Å–∏–æ–Ω–∫–∞</option>
    </select>
    <input type="text" id="f-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
    <input type="text" id="f-price" placeholder="–¶–µ–Ω–∞ (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã)">
    <p style="font-size: 12px; color: var(--tg-hint); margin-top:-10px">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ:</p>
    <input type="file" id="f-photo-file" accept="image/*" multiple>
    <textarea id="f-desc" rows="6" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏..."></textarea>
    <button id="save-btn" onclick="submitData()" style="width:100%; background:var(--tg-link); color:white; padding:18px; border:none; border-radius:14px; font-weight:bold; font-size:16px;">–û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨</button>
    <button onclick="closeForm()" style="width:100%; margin-top:10px; background:none; border:none; color:var(--tg-hint); padding:10px;">–û—Ç–º–µ–Ω–∞</button>
</div>

<div class="tab-bar">
    <div class="tab-item active" onclick="showPage('feed',this)"><span class="icon">üè†</span>–õ–µ–Ω—Ç–∞</div>
    <div class="tab-item" onclick="showPage('powder',this)"><span class="icon">üß™</span>–ü–æ—Ä–æ—Ö</div>
    <div class="tab-item" onclick="showPage('ammo',this)"><span class="icon">üî´</span>–ü–∞—Ç—Ä–æ–Ω—ã</div>
    <div class="tab-item" onclick="showPage('guns',this)"><span class="icon">üß∞</span>–û—Ä—É–∂–∏–µ</div>
    <div class="tab-item" onclick="showPage('commission',this)"><span class="icon">‚ôªÔ∏è</span>–ë/–£</div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.ready(); tg.expand();

// === –¢–í–û–ò –î–ê–ù–ù–´–ï ===
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbx7fDkvV7Bfi_0-pmyslQdjEpH2JWvDyujR1OYe_f9y3CgjTQHCOV1xDwCmuth8XegKhA/exec'; 
const IMGBB_API_KEY = 'bf9f77e41562609d9306b3e2540a0488'; 
const ADMIN_IDS = [461880012,5033819205]; // –¢–≤–æ–π ID –∏ ID –ø–æ–º–æ—â–Ω–∏–∫–æ–≤

let isAdmin=false, isEditing=false, oldName='', currentPhotoUrl='';

if(tg.initDataUnsafe.user && ADMIN_IDS.includes(Number(tg.initDataUnsafe.user.id))){
    isAdmin = true;
    document.getElementById('admin-btn').style.display='block';
}

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ Users
if (tg.initDataUnsafe.user) {
    fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'register', chatId: tg.initDataUnsafe.user.id })});
}

async function loadData(){
    const res = await fetch(WEB_APP_URL + "?action=read&t=" + Date.now());
    const rows = await res.json();
    const containers = {'–Ω–æ–≤–æ—Å—Ç–∏':'feed-list','–ø–æ—Ä–æ—Ö':'powder-list','–ø–∞—Ç—Ä–æ–Ω—ã':'ammo-list','–æ—Ä—É–∂–∏–µ':'guns-list','–∫–æ–º–∏—Å—Å–∏–æ–Ω–∫–∞':'comm-list'};
    Object.values(containers).forEach(id=>document.getElementById(id).innerHTML='');
    
    rows.reverse().forEach(r=>{
        const [cat,name,price,photo,desc,date] = r;
        let photoHtml = '';
        if(photo) {
            const photos = photo.split(',');
            photoHtml = `<div class="gallery-wrapper">
                <div class="gallery" onscroll="updateDots(this)">
                    ${photos.map(p => `<img src="${p.trim()}" onclick="tg.showPhoto('${p.trim()}')">`).join('')}
                </div>
                <div class="dots">${photos.map((_,i)=>`<div class="dot ${i===0?'active':''}"></div>`).join('')}</div>
            </div>`;
        }

        let adminBlock = isAdmin ? `<div class="admin-controls">
            <button class="btn-edit" onclick="openEditForm('${cat}','${name.replace(/'/g,"\\'")}','${price}','${photo}','${desc?desc.replace(/'/g,"\\'"):""}')">–ò–∑–º–µ–Ω–∏—Ç—å</button>
            <button class="btn-delete" onclick="deletePost('${name.replace(/'/g,"\\'")} ')">–£–¥–∞–ª–∏—Ç—å</button>
        </div>` : '';

        const card = `<div class="item-card">${photoHtml}<div class="item-info">
            <span class="item-price">${price} ‚ÇΩ</span>
            <span class="item-title">${name}</span>
            <p class="item-desc">${desc || ''}</p>
            ${adminBlock}
        </div></div>`;
        
        const key = cat.toLowerCase();
        if(containers[key]) document.getElementById(containers[key]).innerHTML += card;
    });
}

function updateDots(el) {
    const scrollLeft = el.scrollLeft;
    const width = el.offsetWidth;
    const index = Math.round(scrollLeft / width);
    const dots = el.parentElement.querySelectorAll('.dot');
    dots.forEach((dot, i) => dot.classList.toggle('active', i === index));
}

function showPage(id,el){
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.tab-item').forEach(t=>t.classList.remove('active'));
    el.classList.add('active');
    window.scrollTo(0,0);
}

function openAddForm(){
    isEditing=false; currentPhotoUrl='';
    document.getElementById('f-name').value='';
    document.getElementById('f-price').value='';
    document.getElementById('f-desc').value='';
    document.getElementById('post-form').style.display='block';
}

function openEditForm(cat,name,price,photo,desc){
    isEditing=true; oldName=name; currentPhotoUrl=photo;
    document.getElementById('f-cat').value=cat;
    document.getElementById('f-name').value=name;
    document.getElementById('f-price').value=price;
    document.getElementById('f-desc').value=desc;
    document.getElementById('post-form').style.display='block';
}

async function submitData(){
    const btn = document.getElementById('save-btn');
    btn.disabled = true; btn.innerText = "–ó–ê–ì–†–£–ñ–ê–ï–ú –§–û–¢–û...";
    
    const files = document.getElementById('f-photo-file').files;
    let urls = isEditing ? currentPhotoUrl.split(',').filter(x=>x) : [];

    for(let file of files){
        const fd = new FormData(); fd.append("image", file);
        try {
            const r = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {method:"POST", body:fd});
            const j = await r.json();
            urls.push(j.data.url);
        } catch(e) { console.error("ImgBB error"); }
    }

    const data = {
        action: isEditing ? 'edit' : 'add',
        oldName,
        category: document.getElementById('f-cat').value,
        name: document.getElementById('f-name').value,
        price: document.getElementById('f-price').value,
        desc: document.getElementById('f-desc').value,
        photo: urls.join(',')
    };

    await fetch(WEB_APP_URL, {method:'POST', mode:'no-cors', body:JSON.stringify(data)});
    tg.HapticFeedback.notificationOccurred('success');
    location.reload();
}

async function deletePost(name){
    if(confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä –Ω–∞–≤—Å–µ–≥–¥–∞?')) {
        await fetch(WEB_APP_URL, {method:'POST', mode:'no-cors', body:JSON.stringify({action:'delete', name})});
        location.reload();
    }
}

function askQuestion(){
    const q = prompt("–í–∞—à –≤–æ–ø—Ä–æ—Å –∞–¥–º–∏–Ω—É (—É–∫–∞–∂–∏—Ç–µ –∫–∞–∫ —Å –≤–∞–º–∏ —Å–≤—è–∑–∞—Ç—å—Å—è):");
    if(q) {
        fetch(WEB_APP_URL, {method:'POST', mode:'no-cors', body:JSON.stringify({
            action:'ask_question', text: q, userId: tg.initDataUnsafe.user.id
        })});
        alert("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –ê–¥–º–∏–Ω —Å–∫–æ—Ä–æ –æ—Ç–≤–µ—Ç–∏—Ç.");
    }
}

function closeForm(){ document.getElementById('post-form').style.display='none'; }
loadData();
</script>
</body>
</html>
