<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root { 
    --tg-bg: #f6f8ff; 
    --tg-text: #000; 
    --tg-link: #248bed; 
    --tg-secondary-bg: #ffffff; 
    --tg-hint: #888;
}
body { font-family: sans-serif; background: linear-gradient(135deg,#f6f8ff,#e6ebff); color: var(--tg-text); margin: 0; padding-bottom: 100px; }
.page { display: none; padding: 15px; }
.page.active { display: block; }
.item-card { background: var(--tg-secondary-bg); border-radius: 15px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
.item-card img { width: 100%; max-height: 250px; object-fit: cover; background: #eee; }
.item-info { padding: 15px; }
.item-price { background: var(--tg-link); color: white; padding: 5px 12px; border-radius: 7px; font-weight: bold; display: inline-block; margin-bottom: 8px; }
.item-title { font-size: 18px; font-weight: bold; display: block; margin-bottom: 5px; }
.item-date { font-size: 12px; color: var(--tg-hint); margin-bottom: 5px; }
.item-desc { font-size: 14px; white-space: pre-wrap; }
.admin-controls { display: flex; gap: 10px; margin-top: 15px; }
.btn-edit { background: var(--tg-link); color: white; border: none; padding: 10px; border-radius: 8px; flex: 1; font-weight: bold; }
.btn-delete { background: #ff4444; color: white; border: none; padding: 10px; border-radius: 8px; flex: 1; font-weight: bold; }
#admin-btn { position: fixed; top: 15px; right: 15px; z-index: 1001; display: none; background: #ff4444; color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 28px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
.tab-bar { position: fixed; bottom: 0; left: 0; right: 0; height: 75px; background: var(--tg-secondary-bg); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid rgba(0,0,0,0.1); z-index: 1000; }
.tab-item { text-align: center; font-size: 11px; flex: 1; color: var(--tg-hint); cursor: pointer; }
.tab-item.active { color: var(--tg-link); font-weight: bold; }
.tab-item .icon { font-size: 24px; display: block; margin-bottom: 4px; }
.form-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--tg-bg); z-index: 2000; padding: 20px; overflow-y: auto; }
input, textarea, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 10px; background: var(--tg-secondary-bg); color: var(--tg-text); font-size: 16px; box-sizing: border-box; }
</style>
</head>
<body>

<button id="admin-btn" onclick="openAddForm()">+</button>

<div id="feed" class="page active"><h2>üî• –õ–µ–Ω—Ç–∞</h2><div id="feed-list"></div></div>
<div id="powder" class="page"><h2>üß™ –ü–æ—Ä–æ—Ö</h2><div id="powder-list"></div></div>
<div id="ammo" class="page"><h2>üî´ –ü–∞—Ç—Ä–æ–Ω—ã</h2><div id="ammo-list"></div></div>
<div id="guns" class="page"><h2>üß∞ –û—Ä—É–∂–∏–µ</h2><div id="guns-list"></div></div>
<div id="commission" class="page"><h2>‚ôªÔ∏è –ö–æ–º–∏—Å—Å–∏–æ–Ω–∫–∞</h2><div id="comm-list"></div></div>

<div id="post-form" class="form-overlay">
    <h3 id="form-title">–ù–æ–≤—ã–π –ø–æ—Å—Ç</h3>
    <select id="f-cat">
        <option value="–ù–æ–≤–æ—Å—Ç–∏">–ù–æ–≤–æ—Å—Ç–∏</option>
        <option value="–ü–æ—Ä–æ—Ö">–ü–æ—Ä–æ—Ö</option>
        <option value="–ü–∞—Ç—Ä–æ–Ω—ã">–ü–∞—Ç—Ä–æ–Ω—ã</option>
        <option value="–û—Ä—É–∂–∏–µ">–û—Ä—É–∂–∏–µ</option>
        <option value="–ö–æ–º–∏—Å—Å–∏–æ–Ω–∫–∞">–ö–æ–º–∏—Å—Å–∏–æ–Ω–∫–∞</option>
    </select>
    <input type="text" id="f-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
    <input type="text" id="f-price" placeholder="–¶–µ–Ω–∞">
    <input type="file" id="f-photo-file" accept="image/*">
    <textarea id="f-desc" rows="4" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
    <button onclick="submitData()" style="width:100%; background:var(--tg-link); color:white; padding:15px; border:none; border-radius:10px; font-weight:bold;">–°–û–•–†–ê–ù–ò–¢–¨</button>
    <button onclick="closeForm()" style="width:100%; margin-top:10px; background:none; border:none; color:var(--tg-hint);">–û—Ç–º–µ–Ω–∞</button>
</div>

<div class="tab-bar">
    <div class="tab-item active" onclick="showPage('feed',this)"><span class="icon">üè†</span>–õ–µ–Ω—Ç–∞</div>
    <div class="tab-item" onclick="showPage('powder',this)"><span class="icon">üß™</span>–ü–æ—Ä–æ—Ö</div>
    <div class="tab-item" onclick="showPage('ammo',this)"><span class="icon">üî´</span>–ü–∞—Ç—Ä–æ–Ω—ã</div>
    <div class="tab-item" onclick="showPage('guns',this)"><span class="icon">üß∞</span>–û—Ä—É–∂–∏–µ</div>
    <div class="tab-item" onclick="showPage('commission',this)"><span class="icon">‚ôªÔ∏è</span>–ö–æ–º–∏—Å—Å.</div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

const READ_URL = 'https://script.google.com/macros/s/AKfycbxEGDonE5hBx86cySoCV0BSYrOrPz0e8XuVoMGh-fMLGaA5Z_m_kaMh2U-x5szeizRjGA/exec';
const WRITE_URL = 'https://script.google.com/macros/s/AKfycbxEGDonE5hBx86cySoCV0BSYrOrPz0e8XuVoMGh-fMLGaA5Z_m_kaMh2U-x5szeizRjGA/exec';
const ADMIN_IDS = [6606101996,461880012]; // –í–∞—à Telegram ID

let isAdmin=false,isEditing=false,oldName='';

if(tg.initDataUnsafe.user && ADMIN_IDS.includes(Number(tg.initDataUnsafe.user.id))){
    isAdmin = true;
    document.getElementById('admin-btn').style.display='block';
}

async function loadData(){
    const res = await fetch(READ_URL+"?cache="+Date.now());
    const rows = await res.json();
    const containers = {'–Ω–æ–≤–æ—Å—Ç–∏':'feed-list','–ø–æ—Ä–æ—Ö':'powder-list','–ø–∞—Ç—Ä–æ–Ω—ã':'ammo-list','–æ—Ä—É–∂–∏–µ':'guns-list','–∫–æ–º–∏—Å—Å–∏–æ–Ω–∫–∞':'comm-list'};
    Object.values(containers).forEach(id=>document.getElementById(id).innerHTML='');
    rows.reverse().forEach(r=>{
        const [cat,name,price,photo,desc,date] = r;
        let adminBlock='';
        if(isAdmin){
            adminBlock=`<div class="admin-controls">
                <button class="btn-edit" onclick="openEditForm('${cat}','${name}','${price}','${photo}','${desc.replace(/'/g,"\\'")}')">–ü—Ä–∞–≤–∏—Ç—å</button>
                <button class="btn-delete" onclick="deletePost('${name}')">–£–¥–∞–ª–∏—Ç—å</button>
            </div>`;
        }
        const card=`<div class="item-card">
            ${photo?`<img src="${photo}">`:''}
            <div class="item-info">
                ${price?`<span class="item-price">${price} ‚ÇΩ</span>`:''}
                <span class="item-title">${name}</span>
                <p class="item-desc">${desc}</p>
                <div class="item-date">üìÖ ${new Date(date).toLocaleDateString()}</div>
                ${adminBlock}
            </div>
        </div>`;
        if(containers[cat.toLowerCase()]) document.getElementById(containers[cat.toLowerCase()]).innerHTML+=card;
    });
}

function showPage(id,el){
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.tab-item').forEach(t=>t.classList.remove('active'));
    el.classList.add('active');
}

function openAddForm(){isEditing=false;post-form.style.display='block';}
function openEditForm(cat,name,price,photo,desc){
    isEditing=true; oldName=name;
    f-cat.value=cat; f-name.value=name; f-price.value=price; f-desc.value=desc;
    post-form.style.display='block';
}
function closeForm(){post-form.style.display='none';}

async function submitData(){
    let base64='',type='';
    const file=f-photo-file.files[0];
    if(file){type=file.type;base64=await toBase64(file);}
    const data={action:isEditing?'edit':'add',oldName,category:f-cat.value,name:f-name.value,price:f-price.value,desc:f-desc.value,photoBase64:base64,photoType:type};
    await fetch(WRITE_URL,{method:'POST',body:JSON.stringify(data)});
    location.reload();
}

async function deletePost(name){
    if(!confirm(`–£–¥–∞–ª–∏—Ç—å "${name}"?`)) return;
    await fetch(WRITE_URL,{method:'POST',body:JSON.stringify({action:'delete',name})});
    location.reload();
}

function toBase64(file){return new Promise(r=>{const fr=new FileReader();fr.onload=()=>r(fr.result.split(',')[1]);fr.readAsDataURL(file);});}

loadData();
</script>
</body>
</html>
