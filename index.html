<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
body { margin:0; font-family:sans-serif; background: linear-gradient(135deg,#f9f9f9,#e0e0ff); color:#333; padding-bottom:100px;}
.page{display:none;padding:15px;}
.page.active{display:block;}
.item-card{background:rgba(255,255,255,0.9);border-radius:20px;margin-bottom:20px;box-shadow:0 6px 15px rgba(0,0,0,0.1);transition:transform 0.2s;}
.item-card:hover{transform:translateY(-3px);}
.item-card img{width:100%;max-height:250px;object-fit:cover;border-radius:15px;}
.item-info{padding:15px;}
.item-price{background:#248bed;color:white;padding:5px 12px;border-radius:7px;font-weight:bold;display:inline-block;margin-bottom:8px;}
.item-title{font-size:18px;font-weight:bold;margin-bottom:5px;}
.item-date{font-size:12px;color:#666;margin-bottom:5px;}
#admin-btn{position:fixed;top:15px;right:15px;z-index:1001;display:none;background:#ff4444;color:white;border:none;border-radius:50%;width:50px;height:50px;font-size:28px;box-shadow:0 4px 12px rgba(0,0,0,0.3);}
.form-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.95);z-index:2000;padding:20px;overflow-y:auto;}
input, textarea, select{width:100%;padding:12px;margin-bottom:10px;border:1px solid #ddd;border-radius:10px;background:#f0f0f0;color:#333;font-size:16px;box-sizing:border-box;}
</style>
</head>
<body>

<button id="admin-btn" onclick="openAddForm()">+</button>

<div id="feed" class="page active"><h2>üî• –õ–µ–Ω—Ç–∞</h2><div id="feed-list"></div></div>

<div id="post-form" class="form-overlay">
<h3 id="form-title">–ù–æ–≤—ã–π –ø–æ—Å—Ç</h3>
<select id="f-cat">
    <option value="–ù–æ–≤–æ—Å—Ç–∏">–ù–æ–≤–æ—Å—Ç–∏</option>
    <option value="–ü–æ—Ä–æ—Ö">–ü–æ—Ä–æ—Ö</option>
    <option value="–ü–∞—Ç—Ä–æ–Ω—ã">–ü–∞—Ç—Ä–æ–Ω—ã</option>
    <option value="–û—Ä—É–∂–∏–µ">–û—Ä—É–∂–∏–µ</option>
    <option value="–ö–æ–º–∏—Å—Å–∏–æ–Ω–∫–∞">–ö–æ–º–∏—Å—Å–∏–æ–Ω–∫–∞</option>
</select>
<input type="text" id="f-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
<input type="text" id="f-price" placeholder="–¶–µ–Ω–∞">
<input type="file" id="photo-upload">
<input type="hidden" id="f-photo">
<textarea id="f-desc" rows="4" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
<button onclick="submitData()" style="width:100%; background:#248bed;color:white;padding:15px;border:none;border-radius:10px;font-weight:bold;">–°–û–•–†–ê–ù–ò–¢–¨</button>
<button onclick="closeForm()" style="width:100%;margin-top:10px;background:none;border:none;color:#666;">–û—Ç–º–µ–Ω–∞</button>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();
const READ_URL = 'https://script.google.com/macros/s/AKfycbyzegRFM-_JaaApisZvGNhPO6SYqXg1yL-1jyDSNoD_wapdYzpu7N4sJDsDU7bueQ2rNg/exec';
const WRITE_URL = 'https://script.google.com/macros/s/AKfycbyzegRFM-_JaaApisZvGNhPO6SYqXg1yL-1jyDSNoD_wapdYzpu7N4sJDsDU7bueQ2rNg/exec';
const ADMIN_IDS = [6606101996,461880012];

let isAdmin = false;
let isEditing = false;
let oldName = "";

if (tg.initDataUnsafe.user && ADMIN_IDS.includes(tg.initDataUnsafe.user.id)){
    isAdmin = true;
    document.getElementById('admin-btn').style.display='block';
}

function escapeHtml(text){ const div=document.createElement('div'); div.textContent=text; return div.innerHTML;}

async function loadData(){
    const res = await fetch(READ_URL+"?cache="+Math.random());
    const posts = await res.json();
    const container = document.getElementById('feed-list');
    container.innerHTML='';
    posts.forEach(post=>{
        const card = document.createElement('div');
        card.className='item-card';
        card.innerHTML = `
            ${post.photo?`<img src="${post.photo}">`:''}
            <div class="item-info">
                <span class="item-price">${escapeHtml(post.price)}</span>
                <span class="item-title">${escapeHtml(post.name)}</span>
                <p class="item-date">–î–∞—Ç–∞: ${new Date(post.date).toLocaleString()}</p>
                <p>${escapeHtml(post.desc)}</p>
            </div>`;
        container.appendChild(card);
    });
}

function openAddForm(){
    isEditing=false;
    document.getElementById('f-cat').value='–ù–æ–≤–æ—Å—Ç–∏';
    document.getElementById('f-name').value='';
    document.getElementById('f-price').value='';
    document.getElementById('f-photo').value='';
    document.getElementById('f-desc').value='';
    document.getElementById('post-form').style.display='block';
}

function closeForm(){ document.getElementById('post-form').style.display='none'; }

document.getElementById('photo-upload').addEventListener('change', async (e)=>{
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async function(evt){
        const base64 = evt.target.result.split(',')[1];
        const payload = { action:'upload', fileBase64: base64, fileName:file.name, fileType:file.type };
        const res = await fetch(WRITE_URL, {method:'POST', body: JSON.stringify(payload)});
        const data = await res.json();
        document.getElementById('f-photo').value = data.url;
    };
    reader.readAsDataURL(file);
});

async function submitData(){
    const data = {
        action: 'add',
        category: document.getElementById('f-cat').value,
        name: document.getElementById('f-name').value,
        price: document.getElementById('f-price').value,
        photo: document.getElementById('f-photo').value,
        desc: document.getElementById('f-desc').value
    };
    await fetch(WRITE_URL,{method:'POST',body: JSON.stringify(data)});
    location.reload();
}

loadData();
</script>
</body>
</html>
